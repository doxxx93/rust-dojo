name: Update Progress

on:
  push:
    branches:
      - main
      - master

jobs:
  update-progress:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed chapters
        id: changed
        run: |
          # PR에서 변경된 파일 목록 가져오기
          FILES=$(git diff --name-only HEAD^..HEAD)
          echo "Changed files:"
          echo "$FILES"

          # 책/챕터 디렉토리 추출
          # 메인 챕터: the-book/01-getting-started/README.md
          # 서브 챕터: the-book/03-common-programming-concepts/01-variables/README.md
          CHAPTERS=$(echo "$FILES" | grep -E '^[^/]+/[^/]+/' | sed 's|/README.md||' | sort -u)

          if [ -z "$CHAPTERS" ]; then
            echo "No chapter directories changed"
            exit 0
          fi

          echo "Changed chapters:"
          echo "$CHAPTERS"

          # 멀티라인 출력을 위한 처리
          echo "chapters<<EOF" >> $GITHUB_OUTPUT
          echo "$CHAPTERS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update issue checkboxes
        if: steps.changed.outputs.chapters != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          CHAPTERS="${{ steps.changed.outputs.chapters }}"

          # 각 변경된 챕터에 대해 처리
          while IFS= read -r chapter; do
            if [ -z "$chapter" ]; then
              continue
            fi

            echo "Processing: $chapter"

            # 책 이름 추출 (예: the-book)
            BOOK=$(echo "$chapter" | cut -d'/' -f1)

            # 책 이름에 따라 Issue 번호 매핑
            case "$BOOK" in
              "the-book")
                ISSUE_NUM=1
                ;;
              "rust-by-example")
                ISSUE_NUM=2
                ;;
              "rustonomicon")
                ISSUE_NUM=3
                ;;
              *)
                echo "Unknown book: $BOOK"
                continue
                ;;
            esac

            # 챕터 번호 추출
            # the-book/01-getting-started → "1"
            # the-book/03-common-programming-concepts/01-variables → "3.1"
            SLASH_COUNT=$(echo "$chapter" | tr -cd '/' | wc -c)

            if [ "$SLASH_COUNT" -eq 1 ]; then
              # 메인 챕터
              CHAPTER_DIR=$(echo "$chapter" | cut -d'/' -f2)
              CHAPTER_NUM=$(echo "$CHAPTER_DIR" | grep -oE '^[0-9]+' | sed 's/^0*//')
              SEARCH_PATTERN="^- \[ \] $CHAPTER_NUM\."
            else
              # 서브 챕터
              MAIN_DIR=$(echo "$chapter" | cut -d'/' -f2)
              SUB_DIR=$(echo "$chapter" | cut -d'/' -f3)
              MAIN_NUM=$(echo "$MAIN_DIR" | grep -oE '^[0-9]+' | sed 's/^0*//')
              SUB_NUM=$(echo "$SUB_DIR" | grep -oE '^[0-9]+' | sed 's/^0*//')
              SEARCH_PATTERN="^  - \[ \] $MAIN_NUM\.$SUB_NUM "
            fi

            echo "Updating Issue #$ISSUE_NUM with pattern: $SEARCH_PATTERN"

            # Issue 본문 가져오기
            ISSUE_BODY=$(gh issue view $ISSUE_NUM --json body -q .body)

            # 체크박스 업데이트 (- [ ] → - [x])
            if [ "$SLASH_COUNT" -eq 1 ]; then
              # 메인 챕터: "- [ ] 1." → "- [x] 1."
              UPDATED_BODY=$(echo "$ISSUE_BODY" | sed "s/^- \[ \] $CHAPTER_NUM\./- [x] $CHAPTER_NUM./")
            else
              # 서브 챕터: "  - [ ] 3.1 " → "  - [x] 3.1 "
              UPDATED_BODY=$(echo "$ISSUE_BODY" | sed "s/^  - \[ \] $MAIN_NUM\.$SUB_NUM /  - [x] $MAIN_NUM.$SUB_NUM /")
            fi

            # Issue 업데이트
            echo "$UPDATED_BODY" | gh issue edit $ISSUE_NUM --body-file -

            # 코멘트 추가
            COMMIT_SHA=$(git rev-parse --short HEAD)
            COMMIT_MSG=$(git log -1 --pretty=%B)
            REPO="${{ github.repository }}"
            SHA="${{ github.sha }}"

            printf "✅ Completed: \`%s\`\n\nCommit: [%s](https://github.com/%s/commit/%s)\nMessage: %s" \
              "$chapter" "$COMMIT_SHA" "$REPO" "$SHA" "$COMMIT_MSG" | \
              gh issue comment $ISSUE_NUM --body-file -

          done <<< "$CHAPTERS"
